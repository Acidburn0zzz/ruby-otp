#!/usr/bin/env ruby
#
# ropiepasswd -  Change or set a user's password for the
#        OPIE authentication system.
#

require 'lib/otp'
require 'optparse'

options = {:algo => "md5", :seq_num => 499}
opts = OptionParser.new do |opts|
    opts.banner =  "usage: opiepasswd [-v] [-h] [-c|-d] [-f]
[-n initial_sequence_number ] [-s seed ] [  user_name ]"
    opts.separator ""
    opts.separator "Options:"

    opts.on_tail("-h", "--help", "Show this message") do
        puts opts
        exit
    end

    opts.on_tail("-v", "--version", "Show version") do
        puts "ropiepasswd 0.0.1"
        exit
    end

    opts.on("-c", "--console", "Set console  mode  where  the  user  is expected  to  have secure access to the system.") do
        options[:c] = 1
    end

    opts.on("-d", "--disable", "Disable  OTP  logins  to  the specified account.") do
            options[:disable] = 1
    end

    opts.on("-f", "--force", "Force opiekey to continue, even where it normally  shouldn't.") do |f|
        options[:force] = 1
    end

    opts.on("-4", "--md4", "Use MD4 hashing algorithm.") do
        options[:algo] = "md4"
    end

    opts.on("-5", "--md5", "Use MD5 hashing algorithm (default).") do 
        options[:algo] = "md5"
    end

    opts.on("--sha1", "Use SHA1 hashing algorithm.") do
        options[:algo] = "sha1"
    end

    opts.on("-512", "--sha512", "Use SHA512 hashing algorithm.") do
        options[:algo] = "sha512"
    end

    opts.on("-n", "--number", String, "Manually  specify  the initial sequence number. The default is 499.") do |n|
        options[:seq_num] = n.to_i
    end

    opts.on("-s", "--seed", String, "Specify a non-random seed.") do |s|
        options[:seed] = s
    end

    opts.on("-u", "--username", String, "Username") do |u|
        options[:username] = u
    end
end

opts.parse(ARGV)

puts "Using the #{options[:algo]} algorithm to compute response."
puts "Reminder: Don't use opiekey from telnet or dial-in sessions."
puts "Enter secret pass phrase: "

# This makes the terminal not echo the pass as you type it in.
`stty -echo`
options[:pass] = STDIN.gets.chomp
`stty echo`

(options[:num] - 1).downto(0) do |i|
    otp = OTP.new(options[:seq_num] - i, options[:seed], options[:pass], options[:algo])
    puts "#{options[:seq_num] - i}: #{otp.to_s}"
end
